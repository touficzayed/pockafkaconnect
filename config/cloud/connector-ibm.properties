# ====================================================================
# Banking S3 Sink Connector - Configuration IBM Cloud (COS)
# ====================================================================

# === CONNECTOR IDENTITY ===
name=banking-s3-sink-ibm-prod
connector.class=io.confluent.connect.s3.S3SinkConnector
tasks.max=6

# === KAFKA SOURCE (IBM Event Streams) ===
topics=payments-in
consumer.override.auto.offset.reset=earliest
consumer.override.max.poll.records=500

# Kafka security (Event Streams)
consumer.override.security.protocol=SASL_SSL
consumer.override.sasl.mechanism=PLAIN
consumer.override.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="${KAFKA_USERNAME}" password="${KAFKA_PASSWORD}";
consumer.override.ssl.protocol=TLSv1.2

# === IBM CLOUD OBJECT STORAGE (COS) ===
s3.bucket.name=banking-payments-prod
s3.region=eu-de

# IBM COS endpoint
store.url=https://s3.eu-de.cloud-object-storage.appdomain.cloud

# IBM COS credentials (HMAC)
aws.access.key.id=${IBM_COS_ACCESS_KEY_ID}
aws.secret.access.key=${IBM_COS_SECRET_ACCESS_KEY}

# IBM COS specific
s3.path.style.access.enabled=false
s3.sse.algorithm=AES256

# === FORMAT ===
format.class=io.confluent.connect.s3.format.json.JsonFormat
storage.class=io.confluent.connect.s3.storage.S3Storage

# === FILE ROTATION ===
# Production: fichiers plus gros, rotation toutes les 15 minutes
rotate.schedule.interval.ms=900000
flush.size=5000

# Nommage des fichiers
s3.object.tagging=true
filename.offset.zero.pad.width=12

# === PARTITIONING ===
partitioner.class=com.banking.kafka.partitioner.BankingHierarchicalPartitioner
partitioner.institution.header=X-Institution-Id
partitioner.event.type.header=X-Event-Type
partitioner.event.version.header=X-Event-Version
partitioner.default.institution=UNKNOWN
partitioner.default.event.type=UNCLASSIFIED
partitioner.default.event.version=v0

# === TRANSFORMS CHAIN ===
transforms=headersToPayload,panTransform,jsonlFormat

# --- Transform 1: Extract Kafka Headers ---
transforms.headersToPayload.type=com.banking.kafka.transforms.HeadersToPayloadTransform
transforms.headersToPayload.mandatory.headers=X-Institution-Id,X-Event-Type,X-Event-Version
transforms.headersToPayload.optional.headers=X-Original-Request-Id,X-Original-Correlation-Id,Original-Idempotency-Key,X-User-Id,X-User-Context-Id
transforms.headersToPayload.target.field=headers
transforms.headersToPayload.fail.on.missing.mandatory=true

# --- Transform 2: PAN Transformation ---
transforms.panTransform.type=com.banking.kafka.transforms.PANTransformationSMT

# Strategy: REMOVE | DECRYPT | REKEY
transforms.panTransform.strategy=REKEY

transforms.panTransform.source.field=encryptedPrimaryAccountNumber
transforms.panTransform.target.field=encryptedPrimaryAccountNumber

# IBM Key Protect integration
transforms.panTransform.key.storage.provider=IBM_KEY_PROTECT
transforms.panTransform.ibm.key.protect.instance.id=${IBM_KEY_PROTECT_INSTANCE_ID}
transforms.panTransform.ibm.key.protect.api.key=${IBM_KEY_PROTECT_API_KEY}
transforms.panTransform.ibm.key.protect.region=eu-de
transforms.panTransform.ibm.key.protect.private.key.id=${IBM_KEY_PROTECT_PRIVATE_KEY_ID}

# Partner keys mapping (stored in COS config bucket)
transforms.panTransform.partner.keys.mapping.provider=COS
transforms.panTransform.partner.keys.mapping.bucket=banking-config-prod
transforms.panTransform.partner.keys.mapping.key=partner-keys-mapping.json
transforms.panTransform.partner.keys.cache.ttl.seconds=3600
transforms.panTransform.institution.header=X-Institution-Id

# JWE configuration
transforms.panTransform.jwe.algorithm=RSA-OAEP-256
transforms.panTransform.jwe.encryption=A256GCM

# --- Transform 3: JSONL Format ---
transforms.jsonlFormat.type=com.banking.kafka.transforms.JSONLFormatTransform
transforms.jsonlFormat.compact=true

# === PGP ENCRYPTION ===
pgp.encryption.enabled=true
pgp.public.key.provider=IBM_KEY_PROTECT
pgp.public.key.id=${IBM_KEY_PROTECT_PGP_KEY_ID}
pgp.armor=false
pgp.compression=ZIP

# === ERROR HANDLING ===
errors.tolerance=all
errors.log.enable=true
errors.log.include.messages=false

# Dead Letter Queue
errors.deadletterqueue.topic.name=banking-payments-dlq
errors.deadletterqueue.topic.replication.factor=3
errors.deadletterqueue.context.headers.enable=true

# Retry configuration
errors.retry.timeout=300000
errors.retry.delay.max.ms=10000

# === LOGGING ===
# Audit log to LogDNA
banking.audit.enabled=true
banking.audit.provider=LOGDNA
banking.audit.logdna.ingestion.key=${LOGDNA_INGESTION_KEY}
banking.audit.logdna.region=eu-de

# === PERFORMANCE TUNING ===
# Larger part size for production
s3.part.size=10485760

# Compression (if PGP disabled, otherwise PGP handles it)
# compression.type=none

# === MONITORING ===
# Metrics to IBM Cloud Monitoring
metrics.recording.level=INFO
metrics.exporter=SYSDIG
metrics.sysdig.endpoint=${SYSDIG_ENDPOINT}
metrics.sysdig.api.key=${SYSDIG_API_KEY}

# === HIGH AVAILABILITY ===
# Kafka Connect distributed mode config
offset.storage.topic=connect-offsets
offset.storage.replication.factor=3
config.storage.topic=connect-configs
config.storage.replication.factor=3
status.storage.topic=connect-status
status.storage.replication.factor=3

# === COMPLIANCE ===
# PCI-DSS: Ensure no PAN in logs
banking.pci.compliant=true
banking.pci.mask.pan.in.logs=true
