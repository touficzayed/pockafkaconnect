# ====================================================================
# Banking S3 Sink Connector - Configuration Locale (MinIO)
# ====================================================================

# === CONNECTOR IDENTITY ===
name=banking-s3-sink-local
connector.class=io.confluent.connect.s3.S3SinkConnector
tasks.max=3

# === KAFKA SOURCE ===
topics=payments-in
consumer.override.auto.offset.reset=earliest
consumer.override.max.poll.records=500

# === S3/MINIO TARGET ===
s3.bucket.name=banking-payments
s3.region=us-east-1
store.url=http://minio:9000
aws.access.key.id=minioadmin
aws.secret.access.key=minioadmin
s3.path.style.access.enabled=true

# === FORMAT ===
format.class=io.confluent.connect.s3.format.json.JsonFormat
storage.class=io.confluent.connect.s3.storage.S3Storage

# === FILE ROTATION ===
# Nouveau fichier toutes les 5 minutes OU tous les 1000 records
rotate.schedule.interval.ms=300000
flush.size=1000

# Nommage des fichiers
s3.object.tagging=true
filename.offset.zero.pad.width=10

# === PARTITIONING ===
partitioner.class=com.banking.kafka.partitioner.BankingHierarchicalPartitioner
partitioner.institution.header=X-Institution-Id
partitioner.event.type.header=X-Event-Type
partitioner.event.version.header=X-Event-Version
partitioner.default.institution=UNKNOWN
partitioner.default.event.type=UNCLASSIFIED
partitioner.default.event.version=v0

# === TRANSFORMS CHAIN ===
transforms=headersToPayload,panTransform,jsonlFormat

# --- Transform 1: Extract Kafka Headers ---
transforms.headersToPayload.type=com.banking.kafka.transforms.HeadersToPayloadTransform
transforms.headersToPayload.mandatory.headers=X-Institution-Id,X-Event-Type,X-Event-Version
transforms.headersToPayload.optional.headers=X-Original-Request-Id,X-Original-Correlation-Id,Original-Idempotency-Key,X-User-Id,X-User-Context-Id
transforms.headersToPayload.target.field=headers
transforms.headersToPayload.fail.on.missing.mandatory=true

# --- Transform 2: PAN Transformation ---
transforms.panTransform.type=com.banking.kafka.transforms.PANTransformationSMT

# Strategy: REMOVE | DECRYPT | REKEY
transforms.panTransform.strategy=DECRYPT

transforms.panTransform.source.field=encryptedPrimaryAccountNumber
transforms.panTransform.target.field=primaryAccountNumber

# Key management for DECRYPT and REKEY
transforms.panTransform.key.storage.provider=FILE
transforms.panTransform.private.key.path=/keys/my-institution/private-key.pem
transforms.panTransform.private.key.id=my-key-2026-01

# Partner keys mapping for REKEY mode
transforms.panTransform.partner.keys.mapping.path=/config/partner-keys-mapping.json
transforms.panTransform.institution.header=X-Institution-Id

# JWE configuration
transforms.panTransform.jwe.algorithm=RSA-OAEP-256
transforms.panTransform.jwe.encryption=A256GCM

# --- Transform 3: JSONL Format ---
transforms.jsonlFormat.type=com.banking.kafka.transforms.JSONLFormatTransform
transforms.jsonlFormat.compact=true

# === PGP ENCRYPTION (OPTIONAL) ===
pgp.encryption.enabled=false
pgp.public.key.path=/keys/pgp/recipient-public.asc
pgp.armor=false
pgp.compression=ZIP

# === ERROR HANDLING ===
errors.tolerance=all
errors.log.enable=true
errors.log.include.messages=true

# Dead Letter Queue
errors.deadletterqueue.topic.name=banking-payments-dlq
errors.deadletterqueue.topic.replication.factor=1
errors.deadletterqueue.context.headers.enable=true

# Retry configuration
errors.retry.timeout=60000
errors.retry.delay.max.ms=5000

# === LOGGING ===
# Log PAN operations (without exposing actual PAN values)
banking.audit.enabled=true
banking.audit.log.path=/var/log/kafka-connect/pan-audit.log

# === PERFORMANCE TUNING ===
# Batch size for S3 uploads
s3.part.size=5242880

# Compression (if PGP disabled)
# compression.type=gzip

# === MONITORING ===
# Custom metrics
metrics.recording.level=INFO
